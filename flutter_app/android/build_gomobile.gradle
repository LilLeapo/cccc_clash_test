// Go Mobileæ„å»ºè„šæœ¬
ext.gomobileBuild = { String targetDir, String pkg ->
    def goModPath = "../../go.mod"
    def outputPath = "${projectDir}/libs"
    
    println "ğŸ”¨ å¼€å§‹æ„å»ºGo Mobileç»‘å®š: ${pkg}"
    
    // æ£€æŸ¥go.modæ–‡ä»¶
    if (!file(goModPath).exists()) {
        println "âŒ go.modæ–‡ä»¶ä¸å­˜åœ¨: ${goModPath}"
        return
    }
    
    // è®¾ç½®GOPATHå’ŒGOMOBILEç¯å¢ƒå˜é‡
    def env = System.getenv()
    def goPath = env.get("GOPATH") ?: System.getProperty("user.home") + "/go"
    def gomobilePath = goPath + "/bin"
    
    println "ğŸ“ Goè·¯å¾„: ${goPath}"
    println "ğŸ“± Gomobileè·¯å¾„: ${gomobilePath}"
    
    // åˆ›å»ºè¾“å‡ºç›®å½•
    new File(outputPath).mkdirs()
    
    try {
        // æ‰§è¡Œgomobile bind
        def cmd = [
            "${gomobilePath}/gomobile",
            "bind",
            "-target=android",
            "-o", "${outputPath}/mihomo.aar",
            "-pkg", "mihomo",
            "./../../go.mod"
        ]
        
        def process = cmd.execute(null, new File(projectDir))
        def output = new StringWriter()
        def error = new StringWriter()
        process.waitForProcessOutput(output, error)
        
        if (process.exitValue() == 0) {
            println "âœ… Go Mobileç»‘å®šæ„å»ºæˆåŠŸ"
            println "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: ${outputPath}/mihomo.aar"
        } else {
            println "âŒ Go Mobileç»‘å®šæ„å»ºå¤±è´¥:"
            println error.toString()
        }
    } catch (Exception e) {
        println "âŒ æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: ${e.message}"
    }
}
